/*
 * JS for monitor generated by Appery.io
 */

Apperyio.getProjectGUID = function() {
    return 'c14f8a8c-776f-4e7f-8d3d-bc94985d8c58';
};

function navigateTo(outcome, useAjax) {
    Apperyio.navigateTo(outcome, useAjax);
}

function adjustContentHeight() {
    Apperyio.adjustContentHeightWithPadding();
}

function adjustContentHeightWithPadding(_page) {
    Apperyio.adjustContentHeightWithPadding(_page);
}

function setDetailContent(pageUrl) {
    Apperyio.setDetailContent(pageUrl);
}

Apperyio.AppPages = [{
    "name": "confirm_driver",
    "location": "confirm_driver.html"
}, {
    "name": "confirm_customer",
    "location": "confirm_customer.html"
}, {
    "name": "confirm_truck",
    "location": "confirm_truck.html"
}, {
    "name": "startScreen",
    "location": "startScreen.html"
}, {
    "name": "monitor",
    "location": "monitor.html"
}];

function monitor_js() {

    /* Object & array with components "name-to-id" mapping */
    var n2id_buf = {
        'offsite_box_man': 'monitor_offsite_box_man',
        'mobilegrid_64': 'monitor_mobilegrid_64',
        'mobilegridcell_65': 'monitor_mobilegridcell_65',
        'current_site_id_label': 'monitor_current_site_id_label',
        'mobilegridcell_green': 'monitor_mobilegridcell_green',
        'googlemap': 'monitor_googlemap',
        'marker_3': 'monitor_marker_3',
        'interval_input': 'monitor_interval_input',
        'toggle_tracking': 'monitor_toggle_tracking',
        'siteTest_button': 'monitor_siteTest_button',
        'mobilebutton_33': 'monitor_mobilebutton_33',
        'mobilebutton_5': 'monitor_mobilebutton_5',
        'mobilegrid_8': 'monitor_mobilegrid_8',
        'mobilegridcell_9': 'monitor_mobilegridcell_9',
        'mobilegridcell_11': 'monitor_mobilegridcell_11',
        'mobilegridcell_13': 'monitor_mobilegridcell_13',
        'spacer_74': 'monitor_spacer_74',
        'shift_ID_label': 'monitor_shift_ID_label',
        'mobilegridcell_14': 'monitor_mobilegridcell_14',
        'mobilegridcell_15': 'monitor_mobilegridcell_15',
        'End_shift_Directions': 'monitor_End_shift_Directions',
        'mobilegridcell_16': 'monitor_mobilegridcell_16',
        'mobilegridcell_73': 'monitor_mobilegridcell_73',
        'end_shift_yes_button': 'monitor_end_shift_yes_button',
        'end_shift_no_button': 'monitor_end_shift_no_button',
        'cancel': 'monitor_cancel',
        'visit_event_grid': 'monitor_visit_event_grid',
        'mobilegridcell_24': 'monitor_mobilegridcell_24',
        'welcomeToLabel_1': 'monitor_welcomeToLabel_1',
        'enter_geo_site_name': 'monitor_enter_geo_site_name',
        'log_off_site_act_label': 'monitor_log_off_site_act_label',
        'mobilegridcell_60': 'monitor_mobilegridcell_60',
        'mobilegridcell_26': 'monitor_mobilegridcell_26',
        'log_activity': 'monitor_log_activity',
        'load_from_truck_button': 'monitor_load_from_truck_button',
        'unload_from_truck_button': 'monitor_unload_from_truck_button',
        'unload_mat_from_box_button': 'monitor_unload_mat_from_box_button',
        'select_material_list': 'monitor_select_material_list',
        'select_material_list_2': 'monitor_select_material_list_2',
        'material_name_item': 'monitor_material_name_item',
        'mobilelistitembutton_55': 'monitor_mobilelistitembutton_55',
        'material_id_item': 'monitor_material_id_item',
        'mobilegridcell_61': 'monitor_mobilegridcell_61',
        'mobilegridcell_28': 'monitor_mobilegridcell_28',
        'dropboxofftruck_button': 'monitor_dropboxofftruck_button',
        'pickupboxontruck_botton': 'monitor_pickupboxontruck_botton',
        'box_list_select': 'monitor_box_list_select',
        'box_list_item_off_site': 'monitor_box_list_item_off_site',
        'box_name_label': 'monitor_box_name_label',
        'mobilelistitembutton_70': 'monitor_mobilelistitembutton_70',
        'box_id_label': 'monitor_box_id_label',
        'mobilegridcell_62': 'monitor_mobilegridcell_62',
        'mobilegridcell_29': 'monitor_mobilegridcell_29',
        'box_number_label': 'monitor_box_number_label',
        'box_loaded_directions': 'monitor_box_loaded_directions',
        'yes_boxisfull_button': 'monitor_yes_boxisfull_button',
        'no_boxisempty_button': 'monitor_no_boxisempty_button',
        'activity_confirm': 'monitor_activity_confirm',
        'close_welcome_popup_button_1': 'monitor_close_welcome_popup_button_1',
        'selected_material_display': 'monitor_selected_material_display',
        'mobilegridcell_63': 'monitor_mobilegridcell_63',
        'leaving_geo_label': 'monitor_leaving_geo_label',
        'spacer_39': 'monitor_spacer_39',
        'leaving_geo_site_name': 'monitor_leaving_geo_site_name',
        'spacer_40': 'monitor_spacer_40',
        'ok_close_button': 'monitor_ok_close_button'
    };

    if ("n2id" in window && window.n2id !== undefined) {
        $.extend(n2id, n2id_buf);
    } else {
        window.n2id = n2id_buf;
    }

    /*
     * Nonvisual components
     */

    Apperyio.mappings = Apperyio.mappings || {};

    Apperyio.mappings["monitor_get_gps_data_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {

            "to_name": "get_gps_data",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "data": {
                    "options": {
                        "maximumAge": 3000,
                        "timeout": 5000,
                        "enableHighAccuracy": true,
                        "watchPosition": false
                    }
                }
            },

            "mappings": []
        }

        ]
    };

    Apperyio.mappings["monitor_get_gps_data_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "get_gps_data",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "monitor",
            "to_type": "UI",

            "mappings": [

            {

                "source": "$['data']['coords']['latitude']",
                "target": "$['googlemap:latitude']"

            },

            {

                "source": "$['data']['coords']['longitude']",
                "target": "$['googlemap:longitude']"

            }

            ]
        },

        {
            "from_name": "get_gps_data",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "lat",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['data']['coords']['latitude']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "get_gps_data",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "lon",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['data']['coords']['longitude']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "get_gps_data",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "speed",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['data']['coords']['speed']",
                "target": "$"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_save_gps_data_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "shift_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "save_gps_data",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target_transformation": function(value) {
                    return localStorage.getItem("shift_id");
                },
                "target": "$['body']['shift_id']"

            }

            ]
        },

        {
            "from_name": "speed",
            "from_type": "LOCAL_STORAGE",

            "to_name": "save_gps_data",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target_transformation": function(value) {
                    return localStorage.getItem("speed");
                },
                "target": "$['body']['speed']"

            }

            ]
        },

        {

            "to_name": "save_gps_data",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "target_transformation": function(value) {
                    return [localStorage.getItem("lat"), localStorage.getItem("lon")];
                },
                "target": "$['body']['location']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_save_gps_data_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": []
    };

    Apperyio.mappings["monitor_end_shift_service_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "end_shift_service",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "ended_at",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['ended_at']",
                "target_transformation": function(value) {
                    var date = new Date();
                    return date.toISOString();
                },
                "target": "$"

            }

            ]
        },

        {
            "from_name": "end_shift_service",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "status",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['status']",
                "target_transformation": function(value) {
                    return ("stopped");
                },
                "target": "$"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_end_shift_service_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "shift_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "monitor",
            "to_type": "UI",

            "mappings": [

            {

                "source": "$",
                "target": "$['shift_ID_label:text']"

            }

            ]
        },

        {
            "from_name": "shift_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "end_shift_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['_id']"

            }

            ]
        },

        {

            "to_name": "end_shift_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "target_transformation": function(value) {
                    return ("stopped");
                },
                "target": "$['body']['status']"

            },

            {

                "target_transformation": function(value) {
                    var date = new Date();
                    return date.toISOString();
                },
                "target": "$['body']['ended_at']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_create_visit_service_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "create_visit_service",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "visit_id",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['_id']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "create_visit_service",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "visit_entered_at",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['entered_at']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "create_visit_service",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "visit_exited_at",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['exited_at']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "currentSiteId",
            "from_type": "LOCAL_STORAGE",

            "to_name": "currentSiteId",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$",
                "target": "$"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_create_visit_service_onbeforesend_mapping_1"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "shift_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_visit_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['shift_id']"

            }

            ]
        },

        {
            "from_name": "currentSiteId",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_visit_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['site_id']"

            }

            ]
        },

        {

            "to_name": "create_visit_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "target_transformation": function(value) {
                    var date = new Date();
                    return date.toISOString();
                },
                "target": "$['body']['entered_at']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_update_truck_loadStatus_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": []
    };

    Apperyio.mappings["monitor_update_truck_loadStatus_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "loadStatus",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_truck_loadStatus",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['loadStatus']"

            }

            ]
        },

        {
            "from_name": "truck_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_truck_loadStatus",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['_id']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_update_visit_on_Exit_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "update_visit_on_Exit",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "visit_exited_at",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['exited_at']",
                "target": "$"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_update_visit_on_Exit_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "visit_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_visit_on_Exit",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['_id']"

            }

            ]
        },

        {

            "to_name": "update_visit_on_Exit",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "target_transformation": function(value) {
                    var date = new Date();
                    var dbdate = date.toISOString();
                    var res = dbdate.split('.', 1) + ".000Z";
                    return res;
                },
                "target": "$['body']['exited_at']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_create_event_service_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "shift_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_event_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['shift_id']"

            }

            ]
        },

        {
            "from_name": "material_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_event_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['material_id']"

            }

            ]
        },

        {
            "from_name": "eventType",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_event_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['eventType']"

            }

            ]
        },

        {
            "from_name": "visit_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_event_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['visit_id']"

            }

            ]
        },

        {
            "from_name": "box_sf_object",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_event_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['box_id']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_create_event_service_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": []
    };

    Apperyio.mappings["monitor_confirm_materials_service_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "confirm_materials_service",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "monitor",
            "to_type": "UI",

            "mappings": [

            {

                "source": "$['body'][i]",
                "target": "$['select_material_list_2']"

            },

            {

                "source": "$['body'][i]['name']",
                "target": "$['select_material_list_2']['material_name_item:text']"

            },

            {

                "source": "$['body'][i]['_id']",
                "target": "$['select_material_list_2']['material_id_item:text']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_confirm_materials_service_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {

            "to_name": "confirm_materials_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}"
                },
                "parameters": {},
                "body": null
            },

            "mappings": []
        }

        ]
    };

    Apperyio.mappings["monitor_return_materials_details_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "monitor",
            "from_type": "UI",

            "to_name": "return_materials_details",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$['material_id_item:text']",
                "target": "$['parameters']['where']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_return_materials_details_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "return_materials_details",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "monitor",
            "to_type": "UI",

            "mappings": [

            {

                "source": "$['body'][0]['name']",
                "target": "$['material_name_item:text']"

            },

            {

                "source": "$['body'][0]['_id']",
                "target": "$['material_id_item:text']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_update_box_service_monitor_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "box_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_box_service_monitor",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['_id']"

            }

            ]
        },

        {
            "from_name": "lat",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_box_service_monitor",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['lastLocation'][0]"

            }

            ]
        },

        {
            "from_name": "lon",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_box_service_monitor",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['lastLocation'][1]"

            }

            ]
        },

        {
            "from_name": "boxLoadStatus",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_box_service_monitor",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['loadstatus']"

            }

            ]
        },

        {
            "from_name": "boxNumber",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_box_service_monitor",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": {
                    "acl": {
                        "*": {
                            "write": true,
                            "read": true
                        }
                    }
                }
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['number']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_update_box_service_monitor_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": []
    };

    Apperyio.mappings["monitor_create_shift_sf_service_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "started_at",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_shift_sf_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['started_at__c']"

            }

            ]
        },

        {
            "from_name": "customer_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_shift_sf_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['customer_id__c']"

            }

            ]
        },

        {
            "from_name": "shift_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_shift_sf_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['shift_id__c']"

            }

            ]
        },

        {
            "from_name": "status",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_shift_sf_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['status__c']"

            }

            ]
        },

        {
            "from_name": "truck_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_shift_sf_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['truck_id__c']"

            }

            ]
        },

        {

            "to_name": "create_shift_sf_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "target_transformation": function(value) {
                    var str = localStorage.getItem("ended_at");
                    var res = str.split('.', 1) + ".000Z";
                    return res;
                },
                "target": "$['body']['ended_at__c']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_create_shift_sf_service_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": []
    };

    Apperyio.mappings["monitor_update_on_clone_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "shift_sf_object",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_on_clone",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['Id']"

            }

            ]
        },

        {

            "to_name": "update_on_clone",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "target_transformation": function(value) {
                    return ("stopped");
                },
                "target": "$['body']['status__c']"

            },

            {

                "target_transformation": function(value) {
                    return ("close");
                },
                "target": "$['body']['note__c']"

            },

            {

                "target_transformation": function(value) {
                    var str = localStorage.getItem("ended_at");
                    var res = str.split('.', 1) + ".000Z";
                    return res;
                },
                "target": "$['body']['ended_at__c']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_update_on_clone_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": []
    };

    Apperyio.mappings["monitor_confirm_box_service_off_site_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "confirm_box_service_off_site",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "monitor",
            "to_type": "UI",

            "mappings": [

            {

                "source": "$['body'][i]",
                "target": "$['box_list_item_off_site']"

            },

            {

                "source": "$['body'][i]['number']",
                "target": "$['box_list_item_off_site']['box_name_label:text']"

            },

            {

                "source": "$['body'][i]['_id']",
                "target": "$['box_list_item_off_site']['box_id_label:text']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_confirm_box_service_off_site_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {

            "to_name": "confirm_box_service_off_site",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}"
                },
                "parameters": {},
                "body": null
            },

            "mappings": []
        }

        ]
    };

    Apperyio.mappings["monitor_return_box_service_off_site_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "monitor",
            "from_type": "UI",

            "to_name": "return_box_service_off_site",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$['box_list_item_off_site:text']",
                "target": "$['parameters']['where']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_return_box_service_off_site_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": []
    };

    Apperyio.mappings["monitor_update_sf_box_service_monitor_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": []
    };

    Apperyio.mappings["monitor_update_sf_box_service_monitor_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "box_sf_object",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_sf_box_service_monitor",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['Id']"

            }

            ]
        },

        {
            "from_name": "lat",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_sf_box_service_monitor",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['Last_Location__Latitude__s']"

            }

            ]
        },

        {
            "from_name": "lon",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_sf_box_service_monitor",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['Last_Location__Longitude__s']"

            }

            ]
        },

        {
            "from_name": "boxLoadStatus",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_sf_box_service_monitor",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['Box_Load_Status__c']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_get_sf_box_service_off_site_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {

            "to_name": "get_sf_box_service_off_site",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}"
                },
                "parameters": {
                    "q": "SELECT Id, Name, Box_Type__c, Status__c FROM Box__c"
                },
                "body": null
            },

            "mappings": []
        }

        ]
    };

    Apperyio.mappings["monitor_get_sf_box_service_off_site_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "get_sf_box_service_off_site",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "monitor",
            "to_type": "UI",

            "mappings": [

            {

                "source": "$['body']['records'][i]",
                "target": "$['box_list_item_off_site']"

            },

            {

                "source": "$['body']['records'][i]['Name']",
                "target": "$['box_list_item_off_site']['box_name_label:text']"

            },

            {

                "source": "$['body']['records'][i]['Id']",
                "target": "$['box_list_item_off_site']['box_id_label:text']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_return_sf_box_service_off_site_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": []
    };

    Apperyio.mappings["monitor_return_sf_box_service_off_site_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {

            "to_name": "return_sf_box_service_off_site",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}"
                },
                "parameters": {
                    "q": "SELECT Id, Name, Box_Type__c, Status__c FROM Box__c"
                },
                "body": null
            },

            "mappings": []
        }

        ]
    };

    Apperyio.mappings["monitor_get_sf_materials_service_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "get_sf_materials_service",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "monitor",
            "to_type": "UI",

            "mappings": [

            {

                "source": "$['body']['records'][i]",
                "target": "$['select_material_list_2']"

            },

            {

                "source": "$['body']['records'][i]['Id']",
                "target": "$['select_material_list_2']['material_id_item:text']"

            },

            {

                "source": "$['body']['records'][i]['Name']",
                "target": "$['select_material_list_2']['material_name_item:text']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_get_sf_materials_service_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {

            "to_name": "get_sf_materials_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}"
                },
                "parameters": {
                    "q": "SELECT Id, Name FROM Material__c"
                },
                "body": null
            },

            "mappings": []
        }

        ]
    };

    Apperyio.mappings["monitor_update_sf_truck_loadstatus_service_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": []
    };

    Apperyio.mappings["monitor_update_sf_truck_loadstatus_service_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "loadStatus",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_sf_truck_loadstatus_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['loadStatus__c']"

            }

            ]
        },

        {
            "from_name": "truck_sf_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_sf_truck_loadstatus_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['Id']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_create_sf_visit_service_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "create_sf_visit_service",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "visit_sf_id",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['id']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "create_sf_visit_service",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "visit_entered_at",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['Entered_at__c']",
                "target": "$"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_create_sf_visit_service_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "shift_sf_object",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_sf_visit_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['Shift__c']"

            }

            ]
        },

        {
            "from_name": "currentSiteId",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_sf_visit_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['Site_Id__c']"

            }

            ]
        },

        {

            "to_name": "create_sf_visit_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "target_transformation": function(value) {
                    var date = new Date();
                    var dbdate = date.toISOString();
                    var res = dbdate.split('.', 1) + ".000Z";
                    return res;
                },
                "target": "$['body']['Entered_at__c']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_create_sf_shiftEvent_service_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "create_sf_shiftEvent_service",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "event_sf_Id",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['id']",
                "target": "$"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_create_sf_shiftEvent_service_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "shift_sf_object",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_sf_shiftEvent_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['Shift__c']"

            }

            ]
        },

        {
            "from_name": "visit_sf_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_sf_shiftEvent_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['Visit__c']"

            }

            ]
        },

        {
            "from_name": "box_sf_object",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_sf_shiftEvent_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['Box__c']"

            }

            ]
        },

        {
            "from_name": "material_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_sf_shiftEvent_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['Material__c']"

            }

            ]
        },

        {
            "from_name": "eventType",
            "from_type": "LOCAL_STORAGE",

            "to_name": "create_sf_shiftEvent_service",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['body']['eventType1__c']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["monitor_update_sf_visit_onsuccess_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": []
    };

    Apperyio.mappings["monitor_update_sf_visit_onbeforesend_mapping_0"] = {
        "homeScreen": "monitor",
        "directions": [

        {
            "from_name": "visit_sf_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "update_sf_visit",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['Id']"

            }

            ]
        },

        {

            "to_name": "update_sf_visit",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "Authorization": "{salesforce_access_token}",
                    "Content-Type": "application/json"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "target_transformation": function(value) {
                    var date = new Date();
                    var str = date.toISOString();
                    console.log("Date in str:", (str));
                    var res = str.split('.', 1) + ".000Z";
                    return res;
                },
                "target": "$['body']['Exited_at__c']"

            }

            ]
        }

        ]
    };

    Apperyio.datasources = Apperyio.datasources || {};

    window.get_gps_data = Apperyio.datasources.get_gps_data = new Apperyio.DataSource(GeolocationService, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_get_gps_data_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_get_gps_data_onsuccess_mapping_0"]);
            Apperyio("gps_test").val(localStorage.getItem("lat") + "," + localStorage.getItem("lon"));
            Apperyio("gps_test").val(localStorage.getItem("speed"));
            try {
                save_gps_data.execute({});
            } catch (e) {
                console.error(e);
                hideSpinner();
            };
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("Failed to Save gps data");
        }
    });

    window.save_gps_data = Apperyio.datasources.save_gps_data = new Apperyio.DataSource(GPSLocationTracking_Locations_create_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_save_gps_data_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            console.log("Latitude:", localStorage.getItem("lat"));
            console.log("Longitute:", localStorage.getItem("lon"));;

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_save_gps_data_onsuccess_mapping_0"]);

            // show key variables in console
            console.log("Current SF Shift ID:", localStorage.getItem("shift_sf_object"));
            //console.log("Current Site Id in Loop:", localStorage.getItem("currentSiteId"));
            console.log("Truck Type:", localStorage.getItem("functionType"));
            console.log("Truck Load Status:", localStorage.getItem("loadStatus"));

            siteMonitor();

            // set variables from localstorage 
            var truckType = localStorage.getItem("functionType");
            var currentSiteId = localStorage.getItem("currentSiteId");
            var truckloadstatus = localStorage.getItem("loadStatus");

            // set truck status
            var isRolloffTruck = (truckType == "rolloff truck"),
                isLoaded = (truckloadstatus == "loaded");

            // check if in visit and set activevisit variable
            //if (typeof currentSiteId == 'undefined' || currentSiteId === null || currentSiteId == "-1") {
            //    activeVisit = false;
            //} 
            // set insite status to be able to show popup
            // added quotes around "-1"
            //var isInSite = (currentSiteId != "-1"), isInActiveVisit = (activeVisit === true), notInVisit = (activeVisit === false); 

            // count times in current site
/*if (isInSite) {
    siteloop++;
} else {
    siteloop = 0;   
}
*/

            //show site and visit status in console
            //console.log("isInActiveVisit:", isInActiveVisit);
            //console.log("IsInSiteLoop:", isInSite);

            // updates the box lastlocation
            //if (isRolloffTruck && isLoaded) {
            //console.log("updating box location");
            //update_sf_box_service_monitor.execute({});
            //update_box_service_monitor.execute({});
            //}
            // this is to check on siteid and activevisit to give popup... untested.
/* if (isInSite && notInVisit && siteloop < 2) {
    var popupElement = Apperyio("weclomeSitepopup_1");
    if (popupElement.popup("option", "positionTo") === "origin") {
        popupElement.popup("open", {
            transition: "slidedown",
            positionTo: "#offsite_box_man" + $(this).attr("offsite_box_man")
	});
    } else {
        popupElement.popup("open", {
            transition: "slidedown"
	});
}
    try {
        create_sf_visit_service.execute({});
        } catch (e) {
        console.error(e);
        hideSpinner();
}
}

*/

            // if (typeof currentSite == 'undefined' || currentSite === null || currentSite == "-1") {
            //                    return;
            //}

            ;
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            window.storeServiceRequest(this);;
        }
    });

    window.end_shift_service = Apperyio.datasources.end_shift_service = new Apperyio.DataSource(stemobiledb_Shifts_update_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_end_shift_service_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            {
                clearInterval(GPSInterval);
                GPSInterval = null;
                $('[dsid=toggle_tracking]').text('Start tracking');
            };
            Apperyio.navigateTo('startScreen', {
                transition: 'fade',
                reverse: false
            });

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_end_shift_service_onsuccess_mapping_0"]);
            try {
                update_on_clone.execute({});
            } catch (e) {
                console.error(e);
                hideSpinner();
            };
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            window.storeServiceRequest(this);
            alert("Failed to Save End Shift Date.  This request will be stored and re-sent when we have data service.");;
        }
    });

    window.create_visit_service = Apperyio.datasources.create_visit_service = new Apperyio.DataSource(stemobiledb_Visits_create_service, {
        "onBeforeSend": function(jqXHR) {
            try {
                $a.storage["visitActive"].update("$", "true")
            } catch (e) {
                console.error(e)
            };
            Apperyio.processMappingAction(Apperyio.mappings["monitor_create_visit_service_onbeforesend_mapping_1"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            console.log("Completed create_visit_serivce Service");

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_create_visit_service_onsuccess_mapping_0"]);
            try {
                $a.c15r("enter_geo_site_name", "set", "text", $a.storage["currentSiteId"].get("$"))
            } catch (e) {
                console.error(e)
            };
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("did not create visit");
        }
    });

    window.update_truck_loadStatus = Apperyio.datasources.update_truck_loadStatus = new Apperyio.DataSource(stemobiledb_Trucks_update_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_truck_loadStatus_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            console.log("Completed Update_truck_loadStatus Service");

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_truck_loadStatus_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("can't change truck loadStatus");
        }
    });

    window.update_visit_on_Exit = Apperyio.datasources.update_visit_on_Exit = new Apperyio.DataSource(stemobiledb_Visits_update_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_visit_on_Exit_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            console.log("Completed Update_visit_on_exit Service");

            //current_site_id_label;
            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_visit_on_Exit_onsuccess_mapping_0"]);
            try {
                $a.storage["visitActive"].update("$", "false")
            } catch (e) {
                console.error(e)
            };
            console.log("Current Visit Id:", localStorage.getItem("visit_id"));
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("failed to save visit exit time");
        }
    });

    window.create_event_service = Apperyio.datasources.create_event_service = new Apperyio.DataSource(stemobiledb_Events_create_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_create_event_service_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_create_event_service_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    window.confirm_materials_service = Apperyio.datasources.confirm_materials_service = new Apperyio.DataSource(stemobiledb_Material_list_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_confirm_materials_service_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_confirm_materials_service_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("Did not successful save Materials -not confirm_amt_suc");
        }
    });

    window.return_materials_details = Apperyio.datasources.return_materials_details = new Apperyio.DataSource(stemobiledb_Material_query_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_return_materials_details_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_return_materials_details_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("didn't return materials in RETURN mat Service");
        }
    });

    window.update_box_service_monitor = Apperyio.datasources.update_box_service_monitor = new Apperyio.DataSource(stemobiledb_Boxes_update_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_box_service_monitor_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            console.log("Completed Update_box_service_monitor Service");

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_box_service_monitor_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("box was not undated");
        }
    });

    window.create_shift_sf_service = Apperyio.datasources.create_shift_sf_service = new Apperyio.DataSource(Salesforce_shift__c_create_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_create_shift_sf_service_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_create_shift_sf_service_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("Failed to save to Salesforce");
        }
    });

    window.update_on_clone = Apperyio.datasources.update_on_clone = new Apperyio.DataSource(Salesforce_shift__c_update_service_clone_1, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_on_clone_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            console.log("Completed Update_on_clone");

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_on_clone_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            window.storeServiceRequest(this);;
        }
    });

    window.confirm_box_service_off_site = Apperyio.datasources.confirm_box_service_off_site = new Apperyio.DataSource(stemobiledb_Boxes_list_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_confirm_box_service_off_site_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_confirm_box_service_off_site_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    window.return_box_service_off_site = Apperyio.datasources.return_box_service_off_site = new Apperyio.DataSource(stemobiledb_Boxes_query_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_return_box_service_off_site_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_return_box_service_off_site_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    window.update_sf_box_service_monitor = Apperyio.datasources.update_sf_box_service_monitor = new Apperyio.DataSource(Salesforce_Box__c_update_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_sf_box_service_monitor_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            console.log("Completed Update_box_sf_service_monitor Service");

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_sf_box_service_monitor_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("Box location was not updated in SalesForce");
        }
    });

    window.get_sf_box_service_off_site = Apperyio.datasources.get_sf_box_service_off_site = new Apperyio.DataSource(Salesforce_Box__c_query_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_get_sf_box_service_off_site_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_get_sf_box_service_off_site_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("Did not get Boxes from Salesforce");
        }
    });

    window.return_sf_box_service_off_site = Apperyio.datasources.return_sf_box_service_off_site = new Apperyio.DataSource(Salesforce_Box__c_query_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_return_sf_box_service_off_site_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_return_sf_box_service_off_site_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    window.get_sf_materials_service = Apperyio.datasources.get_sf_materials_service = new Apperyio.DataSource(Salesforce_Material__c_query_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_get_sf_materials_service_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_get_sf_materials_service_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("Did not successful save Materials from Salesforce");
        }
    });

    window.update_sf_truck_loadstatus_service = Apperyio.datasources.update_sf_truck_loadstatus_service = new Apperyio.DataSource(Salesforce_Truck__c_update_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_sf_truck_loadstatus_service_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            console.log("Completed Update_SF_truck_loadStatus Service");

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_sf_truck_loadstatus_service_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("can't change truck loadStatus in Salesforce");
        }
    });

    window.create_sf_visit_service = Apperyio.datasources.create_sf_visit_service = new Apperyio.DataSource(Salesforce_Visit__c_create_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_create_sf_visit_service_onbeforesend_mapping_0"]);
            console.log("Create Salesforce Visit Before:", localStorage.getItem("shift_sf_object"));
            try {
                $a.storage["visitActive"].update("$", "true")
            } catch (e) {
                console.error(e)
            };
        },
        "onComplete": function(jqXHR, textStatus) {
            console.log("Completed create_sf_visit_serivce");
            console.log("Current SF Shift ID:", localStorage.getItem("shift_sf_object"));

            // set variables from localstorage 
            var truckType = localStorage.getItem("functionType");
            var currentSiteId = localStorage.getItem("currentSiteId");
            var truckloadstatus = localStorage.getItem("loadStatus");

            // set truck status
            var isRolloffTruck = (truckType == "rolloff truck"),
                isLoaded = (truckloadstatus == "loaded");

            //Add Update Box Service Here
            // updates the box lastlocation
            if (isRolloffTruck && isLoaded) {
                console.log("updating box location");
                update_sf_box_service_monitor.execute({});
                //update_box_service_monitor.execute({});
            }

            ;

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_create_sf_visit_service_onsuccess_mapping_0"]);
            try {
                $a.c15r("enter_geo_site_name", "set", "text", $a.storage["currentSiteId"].get("$"))
            } catch (e) {
                console.error(e)
            };
        },
        "onError": function(jqXHR, textStatus, errorThrown) {
            alert("did not create visit in Salesforce");
        }
    });

    window.create_sf_shiftEvent_service = Apperyio.datasources.create_sf_shiftEvent_service = new Apperyio.DataSource(Salesforce_ShiftEvent__c_create_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_create_sf_shiftEvent_service_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_create_sf_shiftEvent_service_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    window.update_sf_visit = Apperyio.datasources.update_sf_visit = new Apperyio.DataSource(Salesforce_Visit__c_update_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_sf_visit_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            console.log("Updated update_sf_visit_serivce");
            console.log("Current SF Shift ID:", localStorage.getItem("shift_sf_object"));

            // set variables from localstorage 
            var truckType = localStorage.getItem("functionType");
            var currentSiteId = localStorage.getItem("currentSiteId");
            var truckloadstatus = localStorage.getItem("loadStatus");

            // set truck status
            var isRolloffTruck = (truckType == "rolloff truck"),
                isLoaded = (truckloadstatus == "loaded");

            // updates the box lastlocation
            if (isRolloffTruck && isLoaded) {
                console.log("updating box location");
                update_sf_box_service_monitor.execute({});
                //update_box_service_monitor.execute({});
            }

            ;

            Apperyio.refreshScreenFormElements("monitor");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["monitor_update_sf_visit_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    Apperyio.CurrentScreen = 'monitor';
    _.chain(Apperyio.mappings).filter(function(m) {
        return m.homeScreen === Apperyio.CurrentScreen;
    }).each(Apperyio.UIHandler.hideTemplateComponents);

    /*
     * Events and handlers
     */

    // On Load
    var monitor_onLoad = function() {
            monitor_elementsExtraJS();

            get_gps_data.execute({});
            $('[dsid=toggle_tracking]').text('Stop tracking');

            GPSInterval = setInterval(function() {
                get_gps_data.execute({})
            }, Appery('interval_input').val() * 1000);
            try {
                $a.c15r("current_site_id_label", "set", "text", $a.storage["currentSiteId"].get("$"))
            } catch (e) {
                console.error(e)
            };

            function setDelay() {
                setTimeout(initialize, 50);
            };

            monitor_deviceEvents();
            monitor_windowEvents();
            monitor_elementsEvents();
        };

    // screen window events


    function monitor_windowEvents() {

        $('#monitor').bind('pageshow orientationchange', function() {
            var _page = this;
            adjustContentHeightWithPadding(_page);
        });
        $('#monitor').on({
            pageshow: function(event) {
                setTimeout(function() {

                    var currentSite = window.localStorage["currentSiteId"];
                    // alert("currentSite: " + currentSite);
                    if (typeof currentSite == 'undefined' || currentSite === null || currentSite == "-1") {
                        return;
                    } else {
                        var popupElement = Apperyio("weclomeSitepopup_1");
                        if (popupElement.popup("option", "positionTo") === "origin") {
                            popupElement.popup("open", {
                                transition: "slidedown",
                                positionTo: "#offsite_box_man" + $(this).attr("offsite_box_man")
                            });
                        } else {
                            popupElement.popup("open", {
                                transition: "slidedown"
                            });
                        }

                        try {
                            create_sf_visit_service.execute({});
                        } catch (e) {
                            console.error(e);
                            hideSpinner();
                        }

                    }
                }, 3000);;
            },
        });

    };

    // device events


    function monitor_deviceEvents() {
        document.addEventListener("deviceready", function() {

        });
    };

    // screen elements extra js


    function monitor_elementsExtraJS() {
        // screen (monitor) extra code

        /* googlemap */

        $("[name = 'googlemap']").wrap("<div/>");
        $("[name = 'googlemap']").parent().css("margin-left", $("[name = 'googlemap']").css("margin-left"));
        $("[name = 'googlemap']").parent().css("margin-right", $("[name = 'googlemap']").css("margin-right"));
        $("[name = 'googlemap']").css("margin-left", '0');
        $("[name = 'googlemap']").css("margin-right", '0');

        var googlemap_options = {
            markerSourceName: "googlemap_markers",
            latitude: "",
            longitude: "",
            address: "Morgantown, WV",
            zoom: 18,
            showLocationMarker: true
        }

        Apperyio.__registerComponent('googlemap', new Apperyio.ApperyMapComponent("googlemap", googlemap_options));
        $("[name='googlemap_markers'] [apperytype='marker']").attr("reRender", "googlemap");
        $(":mobile-pagecontainer").off("pagecontainershow.monitor_mobilecontainer").on("pagecontainershow.monitor_mobilecontainer", function(event, ui) {
            if (($('#monitor_googlemap', ui.toPage).length > 0) && (Apperyio('googlemap') != undefined)) {
                Apperyio('googlemap').refresh();
            }
        });

        /* end_shift_pop_up */
        $("#monitor_end_shift_pop_up").popup("option", "positionTo", "header");

        /* weclomeSitepopup_1 */
        $("#monitor_weclomeSitepopup_1").popup("option", "positionTo", "origin");

        /* select_material_list */

        listView = $("#monitor_select_material_list");
        theme = listView.attr("data-theme");
        if (typeof theme !== 'undefined') {
            var themeClass = "ui-btn-up-" + theme;
            listItem = $("#monitor_select_material_list .ui-li-static");
            $.each(listItem, function(index, value) {
                $(this).addClass(themeClass);
            });
        }

        /* select_material_list_2 */

        /* box_list_select */

        listView = $("#monitor_box_list_select");
        theme = listView.attr("data-theme");
        if (typeof theme !== 'undefined') {
            var themeClass = "ui-btn-up-" + theme;
            listItem = $("#monitor_box_list_select .ui-li-static");
            $.each(listItem, function(index, value) {
                $(this).addClass(themeClass);
            });
        }

        /* box_list_item_off_site */

        /* exit_geo_popup */
        $("#monitor_exit_geo_popup").popup("option", "positionTo", "origin");

    };

    // screen elements handler


    function monitor_elementsEvents() {
        $(document).on("click", "a :input,a a,a fieldset label", function(event) {
            event.stopPropagation();
        });

        $(document).off("click", '#monitor_mobileheader [name="offsite_box_man"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        create_sf_visit_service.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    try {
                        update_sf_box_service_monitor.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    var popupElement = Apperyio("weclomeSitepopup_1");
                    if (popupElement.popup("option", "positionTo") === "origin") {
                        popupElement.popup("open", {
                            transition: "slidedown",
                            positionTo: "#" + $(this).attr("id")
                        });
                    } else {
                        popupElement.popup("open", {
                            transition: "slidedown"
                        });
                    };
                    var offsite = true;
                    var isoffsite = (offsite === true);
                    console.log("Offsite Status", (isoffsite));

                    Apperyio('log_activity').show();
                    Apperyio('log_off_site_act_label').show();

                    //hide these if showing
                    Apperyio('welcomeToLabel_1').hide();
                    Apperyio('load_from_truck_button').hide();
                    Apperyio('selected_material_display').hide();
                    Apperyio('close_welcome_popup_button_1').hide();
                    Apperyio('selected_material_display').hide();
                    Apperyio('unload_mat_from_box_button').hide();
                    Apperyio('pickupboxontruck_botton').hide();

                    ;

                }
            },
        }, '#monitor_mobileheader [name="offsite_box_man"]');

        $(document).off("click", '#monitor_mobilecontainer [name="toggle_tracking"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    if (GPSInterval == null) {
                        GPSInterval = setInterval(function() {
                            get_gps_data.execute({})
                        }, Appery('interval_input').val() * 1000);

                        $('[dsid=toggle_tracking]').text('Stop tracking');
                    } else {
                        clearInterval(GPSInterval);
                        GPSInterval = null;
                        $('[dsid=toggle_tracking]').text('Start tracking');
                    };

                }
            },
        }, '#monitor_mobilecontainer [name="toggle_tracking"]');

        $(document).off("click", '#monitor_mobilefooter [name="siteTest_button"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    var popupElement = Apperyio("weclomeSitepopup_1");
                    if (popupElement.popup("option", "positionTo") === "origin") {
                        popupElement.popup("open", {
                            transition: "fade",
                            positionTo: "#" + $(this).attr("id")
                        });
                    } else {
                        popupElement.popup("open", {
                            transition: "fade"
                        });
                    };
                    try {
                        create_visit_service.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    toggle('monitor_cancel', 'mob', 'true');

                }
            },
        }, '#monitor_mobilefooter [name="siteTest_button"]');
        $(document).off("click", '#monitor_mobilefooter [name="mobilebutton_33"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    var popupElement = Apperyio("exit_geo_popup");
                    if (popupElement.popup("option", "positionTo") === "origin") {
                        popupElement.popup("open", {
                            transition: "fade",
                            positionTo: "#" + $(this).attr("id")
                        });
                    } else {
                        popupElement.popup("open", {
                            transition: "fade"
                        });
                    };

                }
            },
        }, '#monitor_mobilefooter [name="mobilebutton_33"]');
        $(document).off("click", '#monitor_mobilefooter [name="mobilebutton_5"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    var popupElement = Apperyio("end_shift_pop_up");
                    if (popupElement.popup("option", "positionTo") === "origin") {
                        popupElement.popup("open", {
                            transition: "fade",
                            positionTo: "#" + $(this).attr("id")
                        });
                    } else {
                        popupElement.popup("open", {
                            transition: "fade"
                        });
                    };

                }
            },
        }, '#monitor_mobilefooter [name="mobilebutton_5"]');

        $(document).off("click", '#monitor_end_shift_pop_up [name="end_shift_yes_button"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        end_shift_service.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };

                }
            },
        }, '#monitor_end_shift_pop_up [name="end_shift_yes_button"]');
        $(document).off("click", '#monitor_end_shift_pop_up [name="end_shift_no_button"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    Apperyio('end_shift_pop_up').popup('close');

                }
            },
        }, '#monitor_end_shift_pop_up [name="end_shift_no_button"]');
        $(document).off("click", '#monitor_weclomeSitepopup_1').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        $a.storage["currentSiteId"].update("$", $a.c15r($a.UIHandler.resolveGeneratedComponent('enter_geo_site_name', this), 'get', 'text'))
                    } catch (e) {
                        console.error(e)
                    };

                }
            },
        }, '#monitor_weclomeSitepopup_1');
        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="cancel"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    Apperyio('weclomeSitepopup_1').popup('close');
                    //elements to show or hide on Cancel
                    Apperyio('log_activity').show();
                    Apperyio('log_off_site_act_label').show();

                    //hide these if showing
                    Apperyio('welcomeToLabel_1').hide();
                    Apperyio('load_from_truck_button').hide();
                    Apperyio('selected_material_display').hide();
                    Apperyio('close_welcome_popup_button_1').hide();
                    Apperyio('selected_material_display').hide();
                    Apperyio('unload_mat_from_box_button').hide();
                    Apperyio('pickupboxontruck_botton').hide();
                    Apperyio('activity_confirm').hide();
                    Apperyio('dropboxofftruck_button').hide();
                    Apperyio('select_material_list').hide();
                    Apperyio('box_list_select').hide();

                    ;

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="cancel"]');

        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="log_activity"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    console.log("Log Activity Click ActiveVisitId:", localStorage.getItem("activeVisitId"));
                    //show in console.log
                    console.log("Truck Load Status for Event:", localStorage.getItem("loadStatus"));
                    console.log("Truck Type for Event:", localStorage.getItem("functionType"));
                    console.log("Current Box Load Status for Event:", localStorage.getItem("boxLoadStatus"));

                    //Set ActiveVisitId to (CSID or OffSite)
                    // get currentsiteid
                    var currentSite = window.localStorage["currentSiteId"];

                    if (typeof currentSite == 'undefined' || currentSite === null || currentSite == "-1") {
                        (window.localStorage["activeVisitId"] = "offsite");

                    } else {
                        // (window.localStorage["activeVisitId"] = (currentSite));
                        localStorage.setItem("activeVisitId", currentSite);
                    }

                    //determine what type of truck
                    var truckType = localStorage.getItem("functionType");
                    var truckloadstatus = localStorage.getItem("loadStatus");
                    var bls = localStorage.getItem("boxLoadStatus");
                    var isRolloffTruck = (truckType == "rolloff truck"),
                        isWaterTruck = (truckType == "water truck"),
                        isLoaded = (truckloadstatus == "loaded"),
                        isunLoaded = (truckloadstatus == "unloaded"),
                        isfullBox = (bls == "full"),
                        isemptyBox = (bls == "empty");

                    //a loaded, rolloff, with material (LRF)
                    if (isRolloffTruck && isLoaded && isfullBox) {
                        Apperyio('unload_mat_from_box_button').show();
                        Apperyio('dropboxofftruck_button').show();
                        Apperyio('log_activity').hide();
                        Apperyio('welcomeToLabel_1').hide();
                        console.log("updating box location");
                        update_sf_box_service_monitor.execute({});
                    }

                    //a loaded, rolloff, empty (LRE)
                    if (isRolloffTruck && isLoaded && isemptyBox) {
                        Apperyio('unload_from_truck_button').hide();
                        Apperyio('dropboxofftruck_button').show();
                        Apperyio('log_activity').hide();
                        Apperyio('welcomeToLabel_1').hide();
                        console.log("updating box location");
                        update_sf_box_service_monitor.execute({});
                    }

                    //a unloaded rolloff (UR)
                    if (isRolloffTruck && isunLoaded) {
                        Apperyio('pickupboxontruck_botton').show();
                        Apperyio('dropboxofftruck_button').hide();
                        Apperyio('log_activity').hide();
                        Apperyio('welcomeToLabel_1').hide();
                    }

                    //a unloaded water truck (UW)
                    if (isWaterTruck && isunLoaded) {
                        Apperyio('pickupboxontruck_botton').hide();
                        Apperyio('dropboxofftruck_button').hide();
                        Apperyio('log_activity').hide();
                        Apperyio('welcomeToLabel_1').hide();
                        Apperyio('load_from_truck_button').html('Load Water in Truck?');
                        Apperyio('load_from_truck_button').show();

                    }

                    //a loaded water truck (LW)
                    if (isWaterTruck && isLoaded) {
                        Apperyio('pickupboxontruck_botton').hide();
                        Apperyio('dropboxofftruck_button').hide();
                        Apperyio('log_activity').hide();
                        Apperyio('welcomeToLabel_1').hide();
                        Apperyio('unload_from_truck_button').html('Unload Water out of Truck?');
                        Apperyio('unload_from_truck_button').show();
                    }

/*

var truckType = localStorage.getItem("functionType");
var truckloadstatus = localStorage.getItem("loadStatus");

//var boxLoadStatus = localstorage.getItem("boxLoadStatus");

if (truckloadstatus == "loaded") {
  return Apperyio('unload_from_truck_button').show(), Apperyio('log_activity').hide(), Apperyio('welcomeToLabel_1').hide();
} else {
  return Apperyio('select_material_list_2').show(),Apperyio('log_activity').hide(),Apperyio('welcomeToLabel_1').hide(), confirm_materials_service.execute({}); 
}  


//return Apperyio('log_activity').hide(), Apperyio('welcomeToLabel_1').hide(), Apperyio('load_from_truck_button').show(),Apperyio('unload_from_truck_button').show();

//dropboxofftruck_button

Apperyio('unload_from_truck_button').html('Unload Material from Box?');

// test to see if truck is loaded?

*/

                    ;

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="log_activity"]');
        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="load_from_truck_button"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        $a.storage["eventType"].update("$", "loadmaterial")
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_load_from_truck_button', 'mob', 'false');
                    toggle('monitor_unload_from_truck_button', 'mob', 'false');
                    toggle('monitor_select_material_list', 'mob', 'true');
                    toggle('monitor_select_material_list_2', 'mob', 'true');
                    toggle('monitor_material_name_item', 'mob', 'true');
                    try {
                        get_sf_materials_service.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="load_from_truck_button"]');
        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="unload_from_truck_button"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        $a.storage["loadStatus"].update("$", "unloaded")
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        $a.storage["eventType"].update("$", "unloadmaterial")
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_unload_from_truck_button', 'mob', 'false');
                    toggle('monitor_close_welcome_popup_button_1', 'mob', 'true');
                    toggle('monitor_load_from_truck_button', 'mob', 'false');
                    try {
                        $a.c15r("selected_material_display", "set", "text", 'Unloaded Material from Truck')
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        $a.c15r("selected_material_display", "set", "text", $a.storage["materialName"].get("$"))
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_selected_material_display', 'mob', 'true');
                    toggle('monitor_activity_confirm', 'mob', 'true');
                    try {
                        $a.c15r("activity_confirm", "set", "text", 'Unload')
                    } catch (e) {
                        console.error(e)
                    };

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="unload_from_truck_button"]');
        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="unload_mat_from_box_button"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        $a.storage["boxLoadStatus"].update("$", "empty")
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        $a.storage["eventType"].update("$", "unloadmaterial")
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_dropboxofftruck_button', 'mob', 'false');
                    toggle('monitor_unload_mat_from_box_button', 'mob', 'false');
                    try {
                        $a.c15r("activity_confirm", "set", "text", 'Unload Material From Box...')
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_activity_confirm', 'mob', 'true');
                    toggle('monitor_close_welcome_popup_button_1', 'mob', 'true');

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="unload_mat_from_box_button"]');

        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="select_material_list_2"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        $a.storage["material_id"].update("$", $a.c15r($a.UIHandler.resolveGeneratedComponent('material_id_item', this), 'get', 'text'))
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        $a.storage["materialName"].update("$", $a.c15r($a.UIHandler.resolveGeneratedComponent('material_name_item', this), 'get', 'text'))
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        $a.storage["loadStatus"].update("$", "loaded")
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_select_material_list_2', 'mob', 'false');
                    toggle('monitor_select_material_list', 'mob', 'false');
                    toggle('monitor_close_welcome_popup_button_1', 'mob', 'true');
                    try {
                        $a.c15r("selected_material_display", "set", "text", $a.storage["materialName"].get("$"))
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        $a.c15r("activity_confirm", "set", "text", 'Load...')
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_activity_confirm', 'mob', 'true');
                    toggle('monitor_selected_material_display', 'mob', 'true');

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="select_material_list_2"]');

        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="dropboxofftruck_button"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        $a.storage["loadStatus"].update("$", "unloaded")
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        update_sf_truck_loadstatus_service.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    try {
                        update_sf_box_service_monitor.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    setTimeout(function() {

                        console.log("waiting to close");

                    }, 5000);;
                    toggle('monitor_unload_from_truck_button', 'mob', 'false');
                    toggle('monitor_dropboxofftruck_button', 'mob', 'false');
                    try {
                        $a.storage["eventType"].update("$", "dropBox")
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_close_welcome_popup_button_1', 'mob', 'true');
                    try {
                        $a.c15r("activity_confirm", "set", "text", 'Box Dropped.')
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_activity_confirm', 'mob', 'true');
                    toggle('monitor_unload_mat_from_box_button', 'mob', 'false');

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="dropboxofftruck_button"]');
        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="pickupboxontruck_botton"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        $a.storage["eventType"].update("$", "pickupbox")
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        get_sf_box_service_off_site.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    toggle('monitor_box_list_select', 'mob', 'true');
                    toggle('monitor_box_name_label', 'mob', 'true');
                    toggle('monitor_pickupboxontruck_botton', 'mob', 'false');
                    toggle('monitor_box_list_select', 'mob', 'true');
                    toggle('monitor_box_list_item_off_site', 'mob', 'true');
                    try {
                        $a.c15r("selected_material_display", "set", "text", 'box material')
                    } catch (e) {
                        console.error(e)
                    };

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="pickupboxontruck_botton"]');
        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="box_list_select"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    toggle('monitor_box_list_select', 'mob', 'false');

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="box_list_select"]');
        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="box_list_item_off_site"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        $a.storage["boxNumber"].update("$", $a.c15r($a.UIHandler.resolveGeneratedComponent('box_name_label', this), 'get', 'text'))
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        $a.storage["box_id"].update("$", $a.c15r($a.UIHandler.resolveGeneratedComponent('box_id_label', this), 'get', 'text'))
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        $a.storage["loadStatus"].update("$", "loaded")
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        $a.storage["box_sf_object"].update("$", $a.c15r($a.UIHandler.resolveGeneratedComponent('box_id_label', this), 'get', 'text'))
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        return_sf_box_service_off_site.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    toggle('monitor_box_list_item_off_site', 'mob', 'false');
                    try {
                        update_sf_truck_loadstatus_service.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    toggle('monitor_box_loaded_directions', 'mob', 'true');
                    toggle('monitor_yes_boxisfull_button', 'mob', 'true');
                    toggle('monitor_no_boxisempty_button', 'mob', 'true');
                    toggle('monitor_box_list_select', 'mob', 'false');
                    toggle('monitor_box_id_label', 'mob', 'false');
                    try {
                        $a.c15r("box_number_label", "set", "text", $a.storage["boxNumber"].get("$"))
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_box_number_label', 'mob', 'true');
                    toggle('monitor_box_list_item_off_site', 'mob', 'false');
                    toggle('monitor_box_name_label', 'mob', 'false');
                    try {
                        $a.c15r("selected_material_display", "set", "text", $a.storage["materialName"].get("$"))
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_selected_material_display', 'mob', 'false');

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="box_list_item_off_site"]');

        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="yes_boxisfull_button"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        $a.storage["boxLoadStatus"].update("$", "full")
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        $a.storage["materialName"].update("$", "box material")
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        update_sf_box_service_monitor.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    try {
                        $a.c15r("activity_confirm", "set", "text", 'Your full Box is Loaded')
                    } catch (e) {
                        console.error(e)
                    };
                    toggle('monitor_box_loaded_directions', 'mob', 'false');
                    toggle('monitor_yes_boxisfull_button', 'mob', 'false');
                    toggle('monitor_no_boxisempty_button', 'mob', 'false');
                    toggle('monitor_ok_close_button', 'mob', 'true');
                    toggle('monitor_activity_confirm', 'mob', 'true');
                    toggle('monitor_close_welcome_popup_button_1', 'mob', 'true');

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="yes_boxisfull_button"]');
        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="no_boxisempty_button"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        $a.storage["boxLoadStatus"].update("$", "empty")
                    } catch (e) {
                        console.error(e)
                    };
                    try {
                        update_sf_box_service_monitor.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    toggle('monitor_no_boxisempty_button', 'mob', 'false');
                    toggle('monitor_yes_boxisfull_button', 'mob', 'false');
                    toggle('monitor_close_welcome_popup_button_1', 'mob', 'true');
                    toggle('monitor_box_loaded_directions', 'mob', 'false');

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="no_boxisempty_button"]');

        $(document).off("click", '#monitor_weclomeSitepopup_1 [name="close_welcome_popup_button_1"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        create_sf_shiftEvent_service.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    Apperyio('weclomeSitepopup_1').popup('close');
                    toggle('monitor_activity_confirm', 'mob', 'false');
                    toggle('monitor_box_name_label', 'mob', 'false');
                    toggle('monitor_selected_material_display', 'mob', 'false');
                    toggle('monitor_material_name_item', 'mob', 'false');
                    toggle('monitor_box_number_label', 'mob', 'false');
                    toggle('monitor_dropboxofftruck_button', 'mob', 'false');
                    toggle('monitor_log_activity', 'mob', 'true');
                    toggle('monitor_pickupboxontruck_botton', 'mob', 'false');
                    try {
                        update_sf_visit.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    //show in console.log
                    console.log("Clicked OK in Popup:", localStorage.getItem("currentSiteId"));
                    console.log("Clicked OK in Popup:", localStorage.getItem("activeVisitId"));
                    toggle('monitor_ok_close_button', 'mob', 'false');

                }
            },
        }, '#monitor_weclomeSitepopup_1 [name="close_welcome_popup_button_1"]');

        $(document).off("click", '#monitor_exit_geo_popup [name="ok_close_button"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    try {
                        update_visit_on_Exit.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };
                    Apperyio('exit_geo_popup').popup('close');

                }
            },
        }, '#monitor_exit_geo_popup [name="ok_close_button"]');

    };

    $(document).off("pagebeforeshow", "#monitor").on("pagebeforeshow", "#monitor", function(event, ui) {
        Apperyio.CurrentScreen = "monitor";
        _.chain(Apperyio.mappings).filter(function(m) {
            return m.homeScreen === Apperyio.CurrentScreen;
        }).each(Apperyio.UIHandler.hideTemplateComponents);
    });

    monitor_onLoad();
};

$(document).off("pagecreate", "#monitor").on("pagecreate", "#monitor", function(event, ui) {
    Apperyio.processSelectMenu($(this));
    monitor_js();
});